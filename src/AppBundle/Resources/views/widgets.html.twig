{# Widgets for fields #}

{% block widget_field %}
    {% spaceless %}
        {% if (field.widget is defined and field.widget is not null) or field.property is null %}
            {% set _widget = field.widget %}
            {% set _value  = null %}
            {% if field.property is not null %}
                {% set _value  = attribute(entity, field.property.name) %}
            {% endif %}
            {{ block('widget') }}
        {% elseif (field.property|class) == 'ToMany' %}
            {{ block('widget_field_to_many')|raw }}
        {% elseif (field.property|class) == 'ToOne' %}
            {% set _value  = attribute(entity, field.property.name) %}
            {{ block('widget_field_to_one')|raw }}
        {% else %}
            {% set _block = block('widget_field_' ~ (field.property|class|replace({'Type': ''})|lower)) %}
            {% if _block is not empty %}
                {{ _block|raw }}
            {% else %}
                {{ block('widget_field_default') }}
            {% endif %}
        {% endif %}
    {% endspaceless %}
{% endblock %}

{% block widget_field_to_many %}
    <ul>
        {% for item in attribute(entity, field.property.name) %}
            <li>
                {% set _value = item %}
                {{ block('widget_field_to_one') }}
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{% block widget_field_to_one %}
    {{ _value }}
{% endblock %}

{% block widget_field_default %}
    {{ entity|property_accessor(field.mapping) }}
{% endblock %}

{% block widget_field_text %}
    {{ attribute(entity, field.property.name)|nl2br|raw }}
{% endblock %}

{% block widget_field_datetime %}
    {{ entity|property_accessor(field.mapping)|date('Y-m-d H:i:s') }}
{% endblock %}


{# Widgets #}

{% block widget %}
    {% set _block = null %}
    {% if _widget is not null %}
        {% set _block = block('widget_' ~ (_widget|class)|lower) %}
    {% endif %}
    {% if _block is not empty %}
        {{ _block|raw }}
    {% else %}
        {{ block('widget_default') }}
    {% endif %}
{% endblock %}

{% block widget_default %}
    {{ _value }}
{% endblock %}

{% block widget_collection %}
    <ul>
        {% for item in _value %}
            <li>
                {% if _widget.widget is not null %}
                    {% set _original_widget = _widget %}
                    {% set _original_value = _value %}
                    
                    {% set _widget = _widget.widget %}
                    {% set _value = item %}
                    
                    {{ block('widget') }}
                    
                    {% set _widget = _original_widget %}
                    {% set _value = _original_value %}
                {% else %}
                    {{ block('widget_default') }}
                {% endif %}
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{% block widget_expression %}
    {{ _widget.expression|expression(entity, _value) }}
{% endblock %}

{% block widget_link %}
    {% set parameters = {} %}
    {% for parameter in _widget.parameters %}
        {#{% set parameters = parameters|merge({(parameter.parameter): attribute(entity, parameter.property)}) %}#}
        {% set parameters = parameters|merge({(parameter.parameter): 1}) %}
    {% endfor %}
    
    <a href="{{ path(_widget.route, parameters) }}">{{ _value }}</a>
{% endblock %}