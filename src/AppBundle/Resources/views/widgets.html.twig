{# Widgets for fields #}

{% block widget_field %}
    {% spaceless %}
        {% if (field.widget is defined and field.widget is not null) or field.property is null %}
            {% set _widget = field.widget %}
            {% set _value  = null %}
            {% if field.property is not null %}
                {% set _value  = entity|property_accessor(field.mapping) %}
            {% else %}
                {% set _value  = field.name %}
            {% endif %}
            {{ block('widget') }}
        {% elseif (field.property|class) == 'ToMany' %}
            {{ block('widget_field_to_many')|raw }}
        {% elseif (field.property|class) == 'ToOne' %}
            {% set _value  = entity|property_accessor(field.mapping) %}
            {{ block('widget_field_to_one')|raw }}
        {% else %}
            {% set _block = block('widget_field_' ~ (field.property|class|replace({'Type': ''})|lower)) %}
            {% if _block is not empty %}
                {{ _block|raw }}
            {% else %}
                {{ block('widget_field_default') }}
            {% endif %}
        {% endif %}
    {% endspaceless %}
{% endblock %}

{% block widget_field_to_many %}
    <ul>
        {% for item in attribute(entity, field.property.name) %}
            <li>
                {% set _value = item %}
                {{ block('widget_field_to_one') }}
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{% block widget_field_to_one %}
    {{ _value }}
{% endblock %}

{% block widget_field_default %}
    {{ entity|property_accessor(field.mapping) }}
{% endblock %}

{% block widget_field_text %}
    {{ attribute(entity, field.property.name)|nl2br|raw }}
{% endblock %}

{% block widget_field_date %}
    {{ entity|property_accessor(field.mapping)|date('Y-m-d') }}
{% endblock %}

{% block widget_field_datetime %}
    {{ entity|property_accessor(field.mapping)|date('Y-m-d H:i:s') }}
{% endblock %}


{# Widgets #}

{% block widget %}
    {% set _block = null %}
    {% if _widget is not null %}
        {% set _block = block('widget_' ~ (_widget|class)|lower) %}
    {% endif %}
    {% if _block is not empty %}
        {{ _block|raw }}
    {% else %}
        {{ block('widget_default') }}
    {% endif %}
{% endblock %}

{% block widget_default %}
    {{ _value }}
{% endblock %}

{% block widget_collection %}
    <ul>
        {% set _uniqid = ''|uniqid %}
        
        {% set collection_value = _value %}
        {% set collection_widget = _widget %}
        
        {% for item in collection_value %}
            
            {% set attrs = {} %}
            {% if collection_widget.collapse and (collection_value|length > 1) %}
                {% if loop.index0 != 0 %}
                    {% set attrs = {'class': 'collapse-' ~ _uniqid ~ ' collapse'} %}
                {% else %}
                    {% set attrs = {'class': 'collapsor', 'data-toggle': 'collapse', 'data-target': '.collapse-' ~ _uniqid, 'aria-expanded': 'false'} %}
                {% endif %}
            {% endif %}
            
            <li{{ attrs|htmlAttributes }}>
                {% set _value = item %}
                
                {% if collection_widget.widget is not null %}
                    {% set _widget = collection_widget.widget %}
                {% else %}
                    {% set _widget = null %}
                {% endif %}
                
                {{ block('widget') }}
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{% block widget_expression %}
    {{ _widget.expression|expression(entity, _value) }}
{% endblock %}

{% block widget_action %}
    {# GET parameters dictionary #}
    {% set parameters = {} %}
    {% for parameter in _widget.parameters %}
        {% if parameter.property | length %}
            {% set parameter_value = entity|property_accessor(parameter.property) %}
        {% else %}
            {% set parameter_value = parameter.value %}
        {% endif %}
        
        {% set parameters = parameters|merge({(parameter.parameter): parameter_value}) %}
    {% endfor %}
    
    {# POST parameters dictionary #}
    {% set postParameters = {} %}
    {% set postParametersStrings = [] %}
    {% for parameter in _widget.postParameters %}
        {% if parameter.property | length %}
            {% set parameter_value = entity|property_accessor(parameter.property) %}
        {% else %}
            {% set parameter_value = parameter.value %}
        {% endif %}
        
        {% set postParameters = postParameters|merge({(parameter.parameter): parameter_value}) %}
        {% set postParametersStrings = postParametersStrings|merge(['"' ~ parameter.parameter ~ '":"' ~ parameter_value ~ '"']) %}
    {% endfor %}
    {% set postParametersString = '{' ~ (postParametersStrings|join(',')) ~ '}' %}
    
    {% if _widget.method == 'ajax' %}
        <button type="submit" class="btn btn-primary btn-xs appgear-widget-action" data-appgear-widget-action-confirm="{{ _widget.confirm }}" data-appgear-widget-action-url="{{ path(_widget.route, parameters) }}" data-appgear-widget-action-post="{{ _widget.post }}" data-appgear-widget-action-post-parameters='{{ postParametersString }}'>{{ _value }}</button>
    {% else %}
        {% if _widget.post %}
            <form method="post" action="{{ path(_widget.route, parameters) }}" style="margin: 0">
                {% for parameterName, parameterValue in postParameters %}
                    <input type="hidden" name="{{ parameterName }}" value="{{ parameterValue }}"/>
                {% endfor %}
                <button type="submit" class="btn btn-primary btn-xs"{% if _widget.confirm %} onclick="return confirm('Are you sure?')"{% endif %}>{{ _value }}</button>
            </form>
        {% else %}
            {% if _widget.route | length %}
                {% set href = path(_widget.route, parameters) %}
            {% else %}
                {% set href = _widget.link | string_named_sprintf(parameters) %}
            {% endif %}
            
            {% set attrs = {'href':  href} %}
            
            {% if _widget.confirm %}
                {% set attrs = attrs|merge({'onClick': 'return confirm("Are you sure?")'}) %}
            {% endif %}
            {% if _widget.newWindow %}
                {% set attrs = attrs|merge({'target': '_blank'}) %}
            {% endif %}
            
            <a{{ attrs|htmlAttributes }}>{{ _value }}</a>
        {% endif %}
    {% endif %}
{% endblock %}

{% block widget_service %}
    {{ widget_service(_value, _widget) | raw }}
{% endblock %}

{% block widget_view %}
    {{ _widget.view | render( entity|property_accessor(field.mapping)) | raw }}
{% endblock %}

{% block widget_phone %}
    {% if _value|length and _value|phone_valid %}
        {% set _value = _value|phone_format %}
        
        <a href="tel:{{ _value }}">{{ _value }}</a>
        &nbsp;
        <a href="viber://chat?number={{ _value|replace({'+': ''}) }}" class="fab fa-lg fa-viber" style="color:#665cac" title="Viber"></a>
        &nbsp;
        <a href="https://api.whatsapp.com/send?phone={{ _value|replace({'+': ''}) }}" class="fab fa-lg fa-whatsapp" style="color:#09d261" title="WhatsApp"></a>
    {% else %}
        {{ _value }}
    {% endif %}
{% endblock %}

{% block widget_style %}
    {% set classes = [] %}
    {% for tag in _widget.tags %}
        {% if tag.expression|expression(entity) %}
            {% set classes = classes|merge([tag.name]) %}
        {% endif %}
    {% endfor %}
    
    <span{% if classes|length %} class="{{ classes|join(' ') }}"{% endif %}>{{ _value }}</span>
{% endblock %}